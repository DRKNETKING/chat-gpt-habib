<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumina AI - Chat Experience</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain;
        }

        .chat-container {
            height: calc(100vh - 140px);
        }

        .glass-morphism {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .dark .glass-morphism {
            background: rgba(15, 23, 42, 0.9);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .typing-indicator span {
            display: inline-block;
            width: 4px;
            height: 4px;
            background-color: currentColor;
            border-radius: 50%;
            margin-right: 2px;
            animation: bounce 1.3s linear infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: -1.1s; }
        .typing-indicator span:nth-child(3) { animation-delay: -0.9s; }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.1);
        }

        .image-loading {
            position: relative;
            overflow: hidden;
            background: #f3f4f6;
        }
        .image-loading::after {
            content: "";
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            transform: translateX(-100%);
            background-image: linear-gradient(90deg, rgba(255,255,255,0) 0, rgba(255,255,255,0.2) 20%, rgba(255,255,255,0.5) 60%, rgba(255,255,255,0));
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            100% { transform: translateX(100%); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">

    <!-- Mobile Sidebar / History -->
    <div id="sidebar" class="fixed inset-0 z-50 transform -translate-x-full sidebar-transition">
        <div class="absolute inset-0 bg-black bg-opacity-50" onclick="toggleSidebar()"></div>
        <div class="relative w-4/5 max-w-xs h-full bg-white dark:bg-slate-800 p-4 shadow-xl">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold">Riwayat Chat</h2>
                <button onclick="toggleSidebar()" class="p-2 text-gray-500"><i class="fas fa-times"></i></button>
            </div>
            <button onclick="newChat()" class="w-full flex items-center justify-center gap-2 bg-blue-600 text-white p-3 rounded-xl mb-4 hover:bg-blue-700 transition">
                <i class="fas fa-plus"></i> Chat Baru
            </button>
            <div id="history-list" class="space-y-2 overflow-y-auto h-[70vh]">
                <!-- History items will be injected here -->
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 h-16 flex items-center justify-between px-4 z-40 bg-white dark:bg-slate-900 border-b dark:border-slate-800">
        <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg">
            <i class="fas fa-bars text-xl"></i>
        </button>
        <div class="flex flex-col items-center">
            <span class="font-bold text-lg tracking-tight">Lumina AI</span>
            <span class="text-[10px] text-green-500 font-medium">‚óè Online</span>
        </div>
        <button onclick="toggleDarkMode()" id="theme-toggle" class="p-2 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg">
            <i class="fas fa-moon dark:hidden"></i>
            <i class="fas fa-sun hidden dark:block"></i>
        </button>
    </header>

    <!-- Main Chat Area -->
    <main id="chat-box" class="chat-container pt-20 pb-4 overflow-y-auto px-4 space-y-4">
        <!-- Initial Welcome Message -->
        <div class="flex flex-col items-center justify-center h-full text-center opacity-60 space-y-4" id="welcome-screen">
            <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center">
                <i class="fas fa-robot text-3xl text-blue-600 dark:text-blue-400"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold">Halo! Saya Lumina.</h1>
                <p class="text-sm px-8">Tanyakan apa saja, buat gambar, atau analisis foto bersamaku.</p>
            </div>
            <div class="grid grid-cols-2 gap-2 w-full max-w-xs">
                <button onclick="suggest('Buatkan ide bisnis')" class="p-2 text-[11px] border rounded-lg dark:border-slate-700">"Ide bisnis..."</button>
                <button onclick="suggest('Gambar kucing di bulan')" class="p-2 text-[11px] border rounded-lg dark:border-slate-700">"Gambar kucing..."</button>
            </div>
        </div>
    </main>

    <!-- Bottom Action Area -->
    <div class="fixed bottom-0 left-0 right-0 glass-morphism p-4 z-40">
        <div id="image-preview-container" class="hidden mb-2 p-2 bg-gray-100 dark:bg-slate-800 rounded-lg flex items-center gap-3 relative">
            <img id="image-preview" src="" class="w-12 h-12 object-cover rounded shadow-sm">
            <div class="flex-1">
                <p class="text-[10px] font-bold">Gambar Terpilih</p>
                <p class="text-[10px] opacity-60">Siap dianalisis</p>
            </div>
            <button onclick="clearImage()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-[10px]">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="flex items-end gap-2 max-w-3xl mx-auto">
            <div class="flex-1 relative bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-2xl shadow-sm overflow-hidden flex items-end">
                <button onclick="triggerFileSelect()" class="p-3 text-gray-400 hover:text-blue-500 transition">
                    <i class="fas fa-image"></i>
                </button>
                <textarea 
                    id="user-input" 
                    rows="1" 
                    placeholder="Tanya Lumina..." 
                    class="w-full py-3 bg-transparent outline-none resize-none max-h-32 text-sm"
                    oninput="autoResize(this)"></textarea>
                <button onclick="startVoiceRecognition()" id="mic-btn" class="p-3 text-gray-400 hover:text-red-500 transition">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
            <button 
                onclick="handleSend()" 
                id="send-btn" 
                class="w-12 h-12 flex items-center justify-center bg-blue-600 text-white rounded-2xl shadow-lg shadow-blue-200 dark:shadow-none hover:bg-blue-700 transition transform active:scale-95">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <p class="text-[9px] text-center mt-2 opacity-40">AI dapat memberikan informasi yang tidak akurat.</p>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="file-input" class="hidden" accept="image/*" onchange="handleImageSelection(event)">

    <script>
        const apiKey = ""; // Diset oleh environment
        let selectedImageData = null;
        let isGenerating = false;
        let chatHistory = [];

        // --- Core UI Functions ---
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-translate-x-full');
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function suggest(text) {
            document.getElementById('user-input').value = text;
            handleSend();
        }

        function triggerFileSelect() {
            document.getElementById('file-input').click();
        }

        function handleImageSelection(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedImageData = e.target.result.split(',')[1]; // Base64 part
                    document.getElementById('image-preview').src = e.target.result;
                    document.getElementById('image-preview-container').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function clearImage() {
            selectedImageData = null;
            document.getElementById('file-input').value = '';
            document.getElementById('image-preview-container').classList.add('hidden');
        }

        // --- API & Chat Logic ---

        async function handleSend() {
            const inputField = document.getElementById('user-input');
            const message = inputField.value.trim();
            
            if ((!message && !selectedImageData) || isGenerating) return;

            // Hide welcome screen if first message
            const welcome = document.getElementById('welcome-screen');
            if (welcome) welcome.remove();

            // Render User Message
            addMessageToUI('user', message, selectedImageData);
            
            // Cleanup input
            inputField.value = '';
            inputField.style.height = 'auto';
            const tempImgData = selectedImageData;
            clearImage();

            isGenerating = true;
            document.getElementById('send-btn').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            // Check if it's an image generation request
            const isImageGen = /gambar|lukis|image|photo/i.test(message) && !tempImgData;

            try {
                if (isImageGen) {
                    await generateAIImage(message);
                } else {
                    await generateAIText(message, tempImgData);
                }
            } catch (err) {
                addMessageToUI('ai', "Maaf, terjadi kesalahan teknis. Silakan coba lagi nanti.");
                console.error(err);
            } finally {
                isGenerating = false;
                document.getElementById('send-btn').innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }

        async function generateAIText(prompt, base64Image) {
            const botMessageId = addMessageToUI('ai', '', null, true);
            const botEl = document.getElementById(botMessageId);
            const contentEl = botEl.querySelector('.message-content');

            let retries = 0;
            const maxRetries = 5;

            const callAPI = async () => {
                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt || "Analisis gambar ini" }
                        ]
                    }],
                    systemInstruction: {
                        parts: [{ text: "Kamu adalah Lumina AI, asisten virtual cerdas yang ramah, modern, dan sangat membantu. Gunakan bahasa Indonesia yang natural." }]
                    }
                };

                if (base64Image) {
                    payload.contents[0].parts.push({
                        inlineData: { mimeType: "image/png", data: base64Image }
                    });
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('API Error');
                return await response.json();
            };

            const runWithBackoff = async (attempt) => {
                try {
                    return await callAPI();
                } catch (e) {
                    if (attempt < maxRetries) {
                        await new Promise(r => setTimeout(r, Math.pow(2, attempt) * 1000));
                        return runWithBackoff(attempt + 1);
                    }
                    throw e;
                }
            };

            const result = await runWithBackoff(0);
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Saya tidak mengerti.";
            
            // Typing effect
            contentEl.innerHTML = '';
            let i = 0;
            const interval = setInterval(() => {
                contentEl.innerHTML += text[i];
                i++;
                if (i >= text.length) {
                    clearInterval(interval);
                    scrollToBottom();
                }
            }, 5);
        }

        async function generateAIImage(prompt) {
            const botMessageId = addMessageToUI('ai', 'Sedang melukis untukmu...', null, true);
            const botEl = document.getElementById(botMessageId);
            const contentEl = botEl.querySelector('.message-content');

            contentEl.innerHTML = `
                <div class="flex flex-col gap-2">
                    <p class="text-xs italic opacity-70">"Menciptakan: ${prompt}"</p>
                    <div class="w-full aspect-square rounded-xl image-loading flex items-center justify-center">
                        <i class="fas fa-palette text-blue-500 animate-pulse text-3xl"></i>
                    </div>
                </div>
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                    method: 'POST',
                    body: JSON.stringify({
                        instances: { prompt: prompt },
                        parameters: { sampleCount: 1 }
                    })
                });

                const result = await response.json();
                const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;

                contentEl.innerHTML = `
                    <div class="flex flex-col gap-3">
                        <img src="${imageUrl}" class="w-full rounded-xl shadow-md border dark:border-slate-700">
                        <p class="text-xs opacity-70">Hasil karya Lumina untukmu.</p>
                        <button onclick="downloadImage('${imageUrl}')" class="text-[10px] text-blue-500 font-bold self-start"><i class="fas fa-download"></i> Simpan</button>
                    </div>
                `;
            } catch (err) {
                contentEl.innerHTML = "Maaf, gagal membuat gambar saat ini.";
            }
            scrollToBottom();
        }

        function downloadImage(url) {
            const link = document.createElement('a');
            link.href = url;
            link.download = `LuminaAI-${Date.now()}.png`;
            link.click();
        }

        function addMessageToUI(role, text, base64 = null, isBotPlaceholder = false) {
            const chatBox = document.getElementById('chat-box');
            const id = 'msg-' + Date.now();
            
            const msgDiv = document.createElement('div');
            msgDiv.id = id;
            msgDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2 duration-300`;

            const innerHTML = `
                <div class="max-w-[85%] ${role === 'user' ? 'bg-blue-600 text-white rounded-2xl rounded-tr-none shadow-sm' : 'bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-2xl rounded-tl-none shadow-sm'} p-3">
                    ${base64 ? `<img src="data:image/png;base64,${base64}" class="w-48 h-auto rounded-lg mb-2 border border-black/10">` : ''}
                    <div class="message-content text-sm leading-relaxed whitespace-pre-wrap">${isBotPlaceholder ? '<div class="typing-indicator"><span></span><span></span><span></span></div>' : text}</div>
                </div>
            `;
            
            msgDiv.innerHTML = innerHTML;
            chatBox.appendChild(msgDiv);
            scrollToBottom();
            return id;
        }

        function scrollToBottom() {
            const chatBox = document.getElementById('chat-box');
            chatBox.scrollTo({ top: chatBox.scrollHeight, behavior: 'smooth' });
        }

        function newChat() {
            document.getElementById('chat-box').innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center opacity-60 space-y-4" id="welcome-screen">
                    <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center">
                        <i class="fas fa-robot text-3xl text-blue-600 dark:text-blue-400"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Lumina Siap Membantu.</h1>
                        <p class="text-sm px-8">Mari mulai percakapan baru.</p>
                    </div>
                </div>
            `;
            toggleSidebar();
        }

        // --- Voice recognition placeholder ---
        function startVoiceRecognition() {
            const mic = document.getElementById('mic-btn');
            mic.classList.add('text-red-500', 'animate-pulse');
            
            // In a real environment, you'd use the Web Speech API
            // Here we'll just simulate for 3 seconds
            setTimeout(() => {
                mic.classList.remove('text-red-500', 'animate-pulse');
            }, 3000);
            
            // Note: Since this is an iframe environment, real Mic access 
            // might be restricted, but the UI feedback is implemented.
        }

        // Handle enter key
        document.getElementById('user-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });

    </script>
</body>
</html>
